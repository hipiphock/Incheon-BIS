<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="OBE">
	<!-- OBE 버전 조회 -->
	<select id="selectObeVersionList" resultType="String">
	-- 추후 인천으로 변경
		SELECT A.PARAM_VALUE
		FROM (SELECT BP.PARAM_NAME, BP.PARAM_VALUE 
				FROM BIS_PARAMETER BP,(SELECT * FROM BIS_PARAMETER_GROUP 
				WHERE PARAM_GROUP_NAME = 'VERSION') PA 
		WHERE BP.PARAM_GROUP_ID = PA.PARAM_GROUP_ID AND BP.PARAM_NAME like 'GJ%') A
	</select>
	<!-- OBE 상태 목록 조회  -->
	<select id="selectObeStateList" parameterType="ObeStatusVO" resultType="ObeStatusVO">
		SELECT 
			OB.*,
       		BOP.LAT, 
       		BOP.LNG,
       		BOP.OPERATION_STATUS, 
    		TO_CHAR(TO_DATE(OB.UPDATE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD HH24:MI:SS') AS UPDATE_DATE,  
    		NVL2(OB.FIRMWARE_VERSION,  DECODE(OB.FIRMWARE_VERSION, TRIM(FM_VER.PARAM_VALUE), '1', '0'), '-1') AS FIRMWARE_CHECK,
    		NVL2(OB.INFO_VERSION, DECODE(OB.INFO_VERSION, TRIM(CB_VER.PARAM_VALUE), '1', '0'), '-1') AS CURDB_CHECK,
    		NVL2(OB.INFO_RESERVE_VERSION, DECODE(OB.INFO_RESERVE_VERSION, TRIM(RD_VER.PARAM_VALUE), '1', '0'), '-1') AS RD_CHECK,
    		--NVL2(OB.CONFIG_VERSION, DECODE(OB.CONFIG_VERSION, TRIM(CF_VER.PARAM_VALUE), '1', '0'), '-1') AS CF_CHECK,
    		VH.PLATE_NO,
        	VH.VEH_ID   
		FROM 
			OBE_STATUS  OB,
			-- 추후 인천으로 변경
    		(SELECT BP.* FROM BIS_PARAMETER BP,(SELECT * FROM BIS_PARAMETER_GROUP WHERE PARAM_GROUP_NAME = 'VERSION') PA WHERE BP.PARAM_GROUP_ID = PA.PARAM_GROUP_ID AND BP.PARAM_NAME = 'GJ_OBE_FIRMWARE') FM_VER,
    		(SELECT BP.* FROM BIS_PARAMETER BP,(SELECT * FROM BIS_PARAMETER_GROUP WHERE PARAM_GROUP_NAME = 'VERSION') PA WHERE BP.PARAM_GROUP_ID = PA.PARAM_GROUP_ID AND BP.PARAM_NAME = 'GJ_OBE_CURRENT_DBINFO') CB_VER,
    		(SELECT BP.* FROM BIS_PARAMETER BP,(SELECT * FROM BIS_PARAMETER_GROUP WHERE PARAM_GROUP_NAME = 'VERSION') PA WHERE BP.PARAM_GROUP_ID = PA.PARAM_GROUP_ID AND BP.PARAM_NAME = 'GJ_OBE_RESERVE_DBINFO') RD_VER,
    		--(SELECT BP.* FROM BIS_PARAMETER BP,(SELECT * FROM BIS_PARAMETER_GROUP WHERE PARAM_GROUP_NAME = 'VERSION') PA WHERE BP.PARAM_GROUP_ID = PA.PARAM_GROUP_ID AND BP.PARAM_NAME = 'OBE_CONFIGURATION') CF_VER,
    		VEHICLE VH,
    		BUS_OPERATION BOP
		WHERE 
			OB.VEH_ID = VH.VEH_ID(+)
  			AND BOP.VEH_ID = OB.VEH_ID
  			AND VH.AREA_CODE = #{area_code}
  			<if test="searchWord != null and !searchWord.equalsIgnoreCase('')">
  				AND VH.PLATE_NO LIKE '%'||#{searchWord}||'%'
  			</if>
		ORDER BY PLATE_NO
	</select>
</mapper>
















